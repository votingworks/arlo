import re
from typing import List
from flask.testing import FlaskClient
from tests.routes_tests.test_audit_boards import set_up_audit_board
from tests.helpers import set_logged_in_user, DEFAULT_JA_EMAIL
from arlo_server.auth import UserType

DATETIME_REGEX = re.compile(r"\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{6}")

# TODO This is just a basic snapshot test. We still need to implement more
# comprehensive testing.
def test_audit_admin_report(
    client: FlaskClient,
    election_id: str,
    jurisdiction_ids: List[str],
    round_1_id: str,
    contest_ids: List[str],
    audit_board_round_1_ids: List[str],
):
    for audit_board_id in audit_board_round_1_ids:
        set_up_audit_board(
            client,
            election_id,
            jurisdiction_ids[0],
            round_1_id,
            contest_ids[0],
            audit_board_id,
        )
    rv = client.get(f"/election/{election_id}/report")
    report = rv.data.decode("utf-8")
    report = re.sub(DATETIME_REGEX, "DATETIME", report)
    assert report.splitlines() == EXPECTED_AA_REPORT.splitlines()


def test_jurisdiction_admin_report(
    client: FlaskClient,
    election_id: str,
    jurisdiction_ids: List[str],
    round_1_id,
    contest_ids: List[str],
    audit_board_round_1_ids: List[str],
):
    for audit_board_id in audit_board_round_1_ids:
        set_up_audit_board(
            client,
            election_id,
            jurisdiction_ids[0],
            round_1_id,
            contest_ids[0],
            audit_board_id,
        )
    set_logged_in_user(client, UserType.JURISDICTION_ADMIN, DEFAULT_JA_EMAIL)
    rv = client.get(
        f"/election/{election_id}/jurisdiction/{jurisdiction_ids[0]}/report"
    )
    report = rv.data.decode("utf-8")
    report = re.sub(DATETIME_REGEX, "DATETIME", report)
    assert report.splitlines() == EXPECTED_JA_REPORT.splitlines()


EXPECTED_AA_REPORT = """######## ELECTION INFO ########
Election Name,State
Test Election,CA

######## CONTESTS ########
Contest Name,Targeted?,Number of Winners,Votes Allowed,Total Ballots Cast,Tabulated Votes
Contest 1,Targeted,1,1,1000,candidate 1: 600; candidate 2: 400
Contest 2,Opportunistic,2,2,600,candidate 1: 200; candidate 2: 300; candidate 3: 100

######## AUDIT SETTINGS ########
Audit Name,Risk Limit,Random Seed,Online Data Entry?
Test Audit,10%,1234567890,Yes

######## AUDIT BOARDS ########
Jurisdiction Name,Audit Board Name,Member 1 Name,Member 1 Affiliation,Member 2 Name,Member 2 Affiliation
J1,Audit Board #1,Bubbikin Republican,Democrat,Joe Schmo,
J1,Audit Board #2,Bubbikin Republican,Democrat,Joe Schmo,

######## ROUNDS ########
Round Number,Contest Name,Targeted?,Sample Size,Risk Limit Met?,P-Value,Start Time,End Time,Audited Votes
1,Contest 1,Targeted,119,No,,DATETIME,,candidate 1: 0; candidate 2: 0
1,Contest 2,Opportunistic,119,No,,DATETIME,,candidate 1: 0; candidate 2: 0; candidate 3: 0

######## SAMPLED BALLOTS ########
Jurisdiction Name,Batch Name,Ballot Position,Ticket Numbers,Audited?,Audit Result: Contest 1,Audit Result: Contest 2
J1,1,12,Round 1: 0.029898626374613222,AUDITED,candidate 1,
J1,1,21,Round 1: 0.097507658000193474,AUDITED,candidate 1,
J1,2,5,Round 1: 0.009880204677447527,AUDITED,candidate 1,
J1,2,15,Round 1: 0.083638485230135638,AUDITED,candidate 1,
J1,2,25,Round 1: 0.063921946082389022,AUDITED,candidate 1,
J1,2,26,"Round 1: 0.049415923879170303, 0.081722795103841946",AUDITED,candidate 1,
J1,2,32,Round 1: 0.064344935183948458,AUDITED,candidate 1,
J1,2,46,Round 1: 0.040298630475761721,AUDITED,candidate 1,
J1,2,56,Round 1: 0.122658553948710406,AUDITED,candidate 1,
J1,2,70,Round 1: 0.021941471451169393,AUDITED,candidate 2,
J1,3,2,Round 1: 0.042609199829273320,AUDITED,candidate 2,
J1,3,29,Round 1: 0.005485737844734212,AUDITED,candidate 2,
J1,3,34,"Round 1: 0.024245302017344245, 0.069503402643814475",AUDITED,candidate 2,
J1,3,53,Round 1: 0.079988573650917747,AUDITED,candidate 2,
J1,3,58,Round 1: 0.083486109903754340,AUDITED,candidate 2,
J1,3,64,Round 1: 0.085168554836160702,AUDITED,candidate 2,
J1,3,67,Round 1: 0.094448606798300374,AUDITED,candidate 2,
J1,3,76,Round 1: 0.126272907832026485,AUDITED,candidate 2,
J1,3,77,Round 1: 0.090055481652564515,AUDITED,candidate 2,
J1,3,85,Round 1: 0.119043017926633618,AUDITED,candidate 2,
J1,3,90,Round 1: 0.094088629620917882,AUDITED,candidate 2,
J1,3,97,Round 1: 0.038404368212223909,AUDITED,candidate 2,
J1,3,99,Round 1: 0.075051405864746082,AUDITED,candidate 2,
J1,3,107,Round 1: 0.038234097413710039,AUDITED,BLANK,
J1,3,119,Round 1: 0.103215596639352772,AUDITED,BLANK,
J1,4,8,Round 1: 0.036908465434400494,AUDITED,candidate 1,
J1,4,19,Round 1: 0.039175371814673076,AUDITED,candidate 1,
J1,4,23,Round 1: 0.054130711915358102,AUDITED,candidate 1,
J1,4,25,Round 1: 0.084587960812342841,AUDITED,candidate 1,
J1,4,30,Round 1: 0.080450545227510568,AUDITED,candidate 1,
J1,4,50,Round 1: 0.009800391720019182,AUDITED,candidate 1,
J1,4,70,Round 1: 0.103837055385035441,AUDITED,candidate 1,
J1,4,72,Round 1: 0.127406532353632486,AUDITED,candidate 1,
J1,4,76,Round 1: 0.097877511235874384,AUDITED,candidate 1,
J1,4,79,Round 1: 0.011004647116851367,AUDITED,candidate 1,
J1,4,90,Round 1: 0.019140572102897510,AUDITED,candidate 2,
J1,4,107,Round 1: 0.057789995897368832,AUDITED,candidate 2,
J1,4,112,Round 1: 0.103088425698468254,AUDITED,candidate 2,
J1,4,118,Round 1: 0.011979621355982937,AUDITED,candidate 2,
J1,4,136,Round 1: 0.086176519636640979,AUDITED,candidate 2,
J1,4,138,Round 1: 0.024601007542633783,AUDITED,candidate 2,
J1,4,151,Round 1: 0.099893707378789717,AUDITED,candidate 2,
J1,4,155,Round 1: 0.003280982424388856,AUDITED,candidate 2,
J1,4,156,Round 1: 0.093530676101016088,AUDITED,candidate 2,
J1,4,161,Round 1: 0.002273519778823474,AUDITED,candidate 2,
J1,4,162,Round 1: 0.005583579034696292,AUDITED,candidate 2,
J1,4,163,Round 1: 0.053660633322621419,AUDITED,candidate 2,
J1,4,168,Round 1: 0.117015031001908874,AUDITED,candidate 2,
J1,4,179,Round 1: 0.069783615936995520,AUDITED,candidate 2,
J1,4,188,Round 1: 0.125737179379637414,AUDITED,candidate 2,
J1,4,191,Round 1: 0.054705383792225819,AUDITED,BLANK,
J1,4,195,"Round 1: 0.011605572377444965, 0.104478160009884111",AUDITED,BLANK,
J1,4,197,Round 1: 0.077950055597443362,AUDITED,BLANK,
J1,4,210,Round 1: 0.085452296381914985,AUDITED,BLANK,
J1,4,219,"Round 1: 0.016019332853519997, 0.116831568613469832",AUDITED,BLANK,
J1,4,224,Round 1: 0.077039058066978632,AUDITED,BLANK,
J1,4,225,Round 1: 0.063033739981775843,AUDITED,BLANK,
J1,4,242,Round 1: 0.001422917370063674,AUDITED,BLANK,
J1,4,246,Round 1: 0.086922674711608988,AUDITED,BLANK,
J1,4,249,Round 1: 0.004795186182988073,AUDITED,BLANK,
J1,4,250,Round 1: 0.052928705706444505,AUDITED,BLANK,
J1,4,259,Round 1: 0.117848800070428562,AUDITED,BLANK,
J1,4,262,Round 1: 0.029717257151387992,AUDITED,BLANK,
J1,4,269,"Round 1: 0.023351879658140877, 0.121366729957805862",AUDITED,BLANK,
J1,4,295,Round 1: 0.058046981034044064,AUDITED,BLANK,
J1,4,299,Round 1: 0.094678349981996496,AUDITED,BLANK,
J1,4,300,Round 1: 0.100488068481397853,AUDITED,BLANK,
J1,4,333,Round 1: 0.015306349247709058,AUDITED,BLANK,
J1,4,341,Round 1: 0.084190854845044845,AUDITED,BLANK,
J1,4,342,"Round 1: 0.060456051384346034, 0.067991031099023478",AUDITED,BLANK,
J1,4,356,Round 1: 0.010037054248830862,AUDITED,BLANK,
J1,4,364,Round 1: 0.121400229258604463,AUDITED,BLANK,
J1,4,376,Round 1: 0.117296621167114194,AUDITED,BLANK,
J1,4,382,Round 1: 0.038602066872714526,AUDITED,BLANK,
J1,4,383,Round 1: 0.035494065576269651,AUDITED,BLANK,
J2,1,1,"Round 1: 0.108516298247971696, 0.110818217447343018",NOT_AUDITED,,
J2,1,18,Round 1: 0.118212369635047288,NOT_AUDITED,,
J2,2,1,Round 1: 0.122667227691315065,NOT_AUDITED,,
J2,2,7,Round 1: 0.070547975425806567,NOT_AUDITED,,
J2,3,6,Round 1: 0.101617509033972240,NOT_AUDITED,,
J2,3,23,Round 1: 0.011305342382408286,NOT_AUDITED,,
J2,3,47,Round 1: 0.082621989747520600,NOT_AUDITED,,
J2,3,50,Round 1: 0.088571589853756769,NOT_AUDITED,,
J2,3,59,Round 1: 0.100598474119945760,NOT_AUDITED,,
J2,3,61,Round 1: 0.051458420519503544,NOT_AUDITED,,
J2,3,70,Round 1: 0.076189668424782874,NOT_AUDITED,,
J2,3,77,Round 1: 0.054107852599194894,NOT_AUDITED,,
J2,3,87,Round 1: 0.090430425505323501,NOT_AUDITED,,
J2,3,90,Round 1: 0.050887047862634332,NOT_AUDITED,,
J2,3,93,Round 1: 0.036987742224823237,NOT_AUDITED,,
J2,3,108,"Round 1: 0.078303244926317238, 0.089997896922396656",NOT_AUDITED,,
J2,3,113,Round 1: 0.086575399675042791,NOT_AUDITED,,
J2,3,123,Round 1: 0.050862375265696972,NOT_AUDITED,,
J2,3,130,Round 1: 0.004411246208125923,NOT_AUDITED,,
J2,3,147,Round 1: 0.121025282959696224,NOT_AUDITED,,
J2,3,153,Round 1: 0.092320532808751623,NOT_AUDITED,,
J2,3,175,Round 1: 0.106373103215462053,NOT_AUDITED,,
J2,3,188,Round 1: 0.046916823808800973,NOT_AUDITED,,
J2,3,196,Round 1: 0.021628954783788207,NOT_AUDITED,,
J2,3,205,Round 1: 0.111684672316413153,NOT_AUDITED,,
J2,3,206,Round 1: 0.113162179493719045,NOT_AUDITED,,
J2,3,211,Round 1: 0.053013550921156534,NOT_AUDITED,,
J2,3,213,Round 1: 0.014292928821347331,NOT_AUDITED,,
J2,3,219,Round 1: 0.119142280455543538,NOT_AUDITED,,
J2,4,14,Round 1: 0.113543982854908057,NOT_AUDITED,,
J2,4,18,Round 1: 0.038013103949978453,NOT_AUDITED,,
J2,4,25,Round 1: 0.077777948601238256,NOT_AUDITED,,
J2,4,26,"Round 1: 0.000710191532006945, 0.117496458878296268",NOT_AUDITED,,
J2,4,29,Round 1: 0.122889862183711840,NOT_AUDITED,,
J2,4,30,Round 1: 0.035663218359419393,NOT_AUDITED,,
"""

EXPECTED_JA_REPORT = """######## SAMPLED BALLOTS ########
Jurisdiction Name,Batch Name,Ballot Position,Ticket Numbers,Audited?,Audit Result: Contest 1,Audit Result: Contest 2
J1,1,12,Round 1: 0.029898626374613222,AUDITED,candidate 1,
J1,1,21,Round 1: 0.097507658000193474,AUDITED,candidate 1,
J1,2,5,Round 1: 0.009880204677447527,AUDITED,candidate 1,
J1,2,15,Round 1: 0.083638485230135638,AUDITED,candidate 1,
J1,2,25,Round 1: 0.063921946082389022,AUDITED,candidate 1,
J1,2,26,"Round 1: 0.049415923879170303, 0.081722795103841946",AUDITED,candidate 1,
J1,2,32,Round 1: 0.064344935183948458,AUDITED,candidate 1,
J1,2,46,Round 1: 0.040298630475761721,AUDITED,candidate 1,
J1,2,56,Round 1: 0.122658553948710406,AUDITED,candidate 1,
J1,2,70,Round 1: 0.021941471451169393,AUDITED,candidate 2,
J1,3,2,Round 1: 0.042609199829273320,AUDITED,candidate 2,
J1,3,29,Round 1: 0.005485737844734212,AUDITED,candidate 2,
J1,3,34,"Round 1: 0.024245302017344245, 0.069503402643814475",AUDITED,candidate 2,
J1,3,53,Round 1: 0.079988573650917747,AUDITED,candidate 2,
J1,3,58,Round 1: 0.083486109903754340,AUDITED,candidate 2,
J1,3,64,Round 1: 0.085168554836160702,AUDITED,candidate 2,
J1,3,67,Round 1: 0.094448606798300374,AUDITED,candidate 2,
J1,3,76,Round 1: 0.126272907832026485,AUDITED,candidate 2,
J1,3,77,Round 1: 0.090055481652564515,AUDITED,candidate 2,
J1,3,85,Round 1: 0.119043017926633618,AUDITED,candidate 2,
J1,3,90,Round 1: 0.094088629620917882,AUDITED,candidate 2,
J1,3,97,Round 1: 0.038404368212223909,AUDITED,candidate 2,
J1,3,99,Round 1: 0.075051405864746082,AUDITED,candidate 2,
J1,3,107,Round 1: 0.038234097413710039,AUDITED,BLANK,
J1,3,119,Round 1: 0.103215596639352772,AUDITED,BLANK,
J1,4,8,Round 1: 0.036908465434400494,AUDITED,candidate 1,
J1,4,19,Round 1: 0.039175371814673076,AUDITED,candidate 1,
J1,4,23,Round 1: 0.054130711915358102,AUDITED,candidate 1,
J1,4,25,Round 1: 0.084587960812342841,AUDITED,candidate 1,
J1,4,30,Round 1: 0.080450545227510568,AUDITED,candidate 1,
J1,4,50,Round 1: 0.009800391720019182,AUDITED,candidate 1,
J1,4,70,Round 1: 0.103837055385035441,AUDITED,candidate 1,
J1,4,72,Round 1: 0.127406532353632486,AUDITED,candidate 1,
J1,4,76,Round 1: 0.097877511235874384,AUDITED,candidate 1,
J1,4,79,Round 1: 0.011004647116851367,AUDITED,candidate 1,
J1,4,90,Round 1: 0.019140572102897510,AUDITED,candidate 2,
J1,4,107,Round 1: 0.057789995897368832,AUDITED,candidate 2,
J1,4,112,Round 1: 0.103088425698468254,AUDITED,candidate 2,
J1,4,118,Round 1: 0.011979621355982937,AUDITED,candidate 2,
J1,4,136,Round 1: 0.086176519636640979,AUDITED,candidate 2,
J1,4,138,Round 1: 0.024601007542633783,AUDITED,candidate 2,
J1,4,151,Round 1: 0.099893707378789717,AUDITED,candidate 2,
J1,4,155,Round 1: 0.003280982424388856,AUDITED,candidate 2,
J1,4,156,Round 1: 0.093530676101016088,AUDITED,candidate 2,
J1,4,161,Round 1: 0.002273519778823474,AUDITED,candidate 2,
J1,4,162,Round 1: 0.005583579034696292,AUDITED,candidate 2,
J1,4,163,Round 1: 0.053660633322621419,AUDITED,candidate 2,
J1,4,168,Round 1: 0.117015031001908874,AUDITED,candidate 2,
J1,4,179,Round 1: 0.069783615936995520,AUDITED,candidate 2,
J1,4,188,Round 1: 0.125737179379637414,AUDITED,candidate 2,
J1,4,191,Round 1: 0.054705383792225819,AUDITED,BLANK,
J1,4,195,"Round 1: 0.011605572377444965, 0.104478160009884111",AUDITED,BLANK,
J1,4,197,Round 1: 0.077950055597443362,AUDITED,BLANK,
J1,4,210,Round 1: 0.085452296381914985,AUDITED,BLANK,
J1,4,219,"Round 1: 0.016019332853519997, 0.116831568613469832",AUDITED,BLANK,
J1,4,224,Round 1: 0.077039058066978632,AUDITED,BLANK,
J1,4,225,Round 1: 0.063033739981775843,AUDITED,BLANK,
J1,4,242,Round 1: 0.001422917370063674,AUDITED,BLANK,
J1,4,246,Round 1: 0.086922674711608988,AUDITED,BLANK,
J1,4,249,Round 1: 0.004795186182988073,AUDITED,BLANK,
J1,4,250,Round 1: 0.052928705706444505,AUDITED,BLANK,
J1,4,259,Round 1: 0.117848800070428562,AUDITED,BLANK,
J1,4,262,Round 1: 0.029717257151387992,AUDITED,BLANK,
J1,4,269,"Round 1: 0.023351879658140877, 0.121366729957805862",AUDITED,BLANK,
J1,4,295,Round 1: 0.058046981034044064,AUDITED,BLANK,
J1,4,299,Round 1: 0.094678349981996496,AUDITED,BLANK,
J1,4,300,Round 1: 0.100488068481397853,AUDITED,BLANK,
J1,4,333,Round 1: 0.015306349247709058,AUDITED,BLANK,
J1,4,341,Round 1: 0.084190854845044845,AUDITED,BLANK,
J1,4,342,"Round 1: 0.060456051384346034, 0.067991031099023478",AUDITED,BLANK,
J1,4,356,Round 1: 0.010037054248830862,AUDITED,BLANK,
J1,4,364,Round 1: 0.121400229258604463,AUDITED,BLANK,
J1,4,376,Round 1: 0.117296621167114194,AUDITED,BLANK,
J1,4,382,Round 1: 0.038602066872714526,AUDITED,BLANK,
J1,4,383,Round 1: 0.035494065576269651,AUDITED,BLANK,
"""
